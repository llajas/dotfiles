#!/bin/sh
set -eu

# Skip non-Linux
[ "{{ .chezmoi.os }}" = "linux" ] || exit 0

# Helper: do we already have a usable UTF-8 locale installed?
have_utf8_locale() {
  locale -a 2>/dev/null | grep -qiE '^(en_US\.utf8|en_US\.UTF-8|C\.utf8)$'
}

if have_utf8_locale; then
  echo "[fix-locale] UTF-8 locale already available:"
  locale -a 2>/dev/null | grep -iE 'en_US\.utf8|C\.utf8' || true
  exit 0
fi

echo "[fix-locale] No en_US.UTF-8 locale installed, attempting to fix..."

distro_id=$(grep '^ID=' /etc/os-release | cut -d= -f2 | tr -d '"')

case "$distro_id" in
  ubuntu|debian)
    echo "[fix-locale] Installing/Generating en_US.UTF-8 for $distro_id"
    # Ensure it's in /etc/locale.gen
    if ! grep -q '^en_US.UTF-8 UTF-8' /etc/locale.gen 2>/dev/null; then
      echo "en_US.UTF-8 UTF-8" | sudo tee -a /etc/locale.gen >/dev/null
    fi
    sudo locale-gen
    echo -e 'LANG=en_US.UTF-8\nLC_ALL=en_US.UTF-8' | sudo tee /etc/default/locale >/dev/null
    ;;

  fedora|rhel|centos|rocky|almalinux)
    echo "[fix-locale] Installing glibc-langpack-en on $distro_id"
    if command -v dnf >/dev/null 2>&1; then
      sudo dnf install -y glibc-langpack-en
    elif command -v yum >/dev/null 2>&1; then
      sudo yum install -y glibc-langpack-en
    fi
    sudo localectl set-locale LANG=en_US.UTF-8
    ;;

  arch)
    echo "[fix-locale] Generating en_US.UTF-8 on Arch"
    echo "en_US.UTF-8 UTF-8" | sudo tee -a /etc/locale.gen >/dev/null
    sudo locale-gen
    echo "LANG=en_US.UTF-8" | sudo tee /etc/locale.conf >/dev/null
    ;;

  *)
    echo "[fix-locale] Unknown distro ($distro_id), skipping automated fix."
    ;;
esac

echo "[fix-locale] Resulting locales:"
locale -a 2>/dev/null | grep -i 'en_US' || true
