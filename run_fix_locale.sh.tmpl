#!/bin/sh
set -eu

# Skip non-Linux hosts
[ "{{ .chezmoi.os }}" = "linux" ] || exit 0

# Check for existing en_US.UTF-8 locale
have_en_us_utf8() {
  locale -a 2>/dev/null | grep -qiE 'en_US\.utf8|en_US\.UTF-8'
}

if have_en_us_utf8; then
  echo "[fix-locale] en_US.UTF-8 already available:"
  locale -a 2>/dev/null | grep -i 'en_US\.utf8' || true
  exit 0
fi

echo "[fix-locale] No en_US.UTF-8 locale installed, attempting to fix..."

distro_id=$(grep '^ID=' /etc/os-release | cut -d= -f2 | tr -d '"')

case "$distro_id" in
  ubuntu|debian)
    echo "[fix-locale] Detected Debian/Ubuntu"

    # Ensure locale package is present
    if ! command -v locale-gen >/dev/null 2>&1; then
      echo "[fix-locale] Installing 'locales' package"
      sudo apt-get update && sudo apt-get install -y locales
    fi

    # Ensure en_US.UTF-8 is in locale.gen
    if [ -f /etc/locale.gen ]; then
      if ! grep -q '^en_US.UTF-8 UTF-8' /etc/locale.gen; then
        echo "en_US.UTF-8 UTF-8" | sudo tee -a /etc/locale.gen >/dev/null
      fi
    fi

    sudo locale-gen
    printf 'LANG=en_US.UTF-8\nLC_ALL=en_US.UTF-8\n' | sudo tee /etc/default/locale >/dev/null
    ;;

  fedora|rhel|centos|rocky|almalinux)
    echo "[fix-locale] Detected RHEL/Fedora family"
    sudo dnf install -y glibc-langpack-en || sudo yum install -y glibc-langpack-en
    sudo localectl set-locale LANG=en_US.UTF-8
    ;;

  arch)
    echo "[fix-locale] Detected Arch Linux"
    if ! grep -q '^en_US.UTF-8 UTF-8' /etc/locale.gen; then
      echo "en_US.UTF-8 UTF-8" | sudo tee -a /etc/locale.gen >/dev/null
    fi
    sudo locale-gen
    echo "LANG=en_US.UTF-8" | sudo tee /etc/locale.conf >/dev/null
    ;;

  *)
    echo "[fix-locale] Unknown distro ($distro_id)"
    echo "[fix-locale] Trying fallback: localedef"

    if command -v localedef >/dev/null 2>&1; then
      echo "[fix-locale] Using localedef to generate en_US.UTF-8"
      sudo localedef -i en_US -f UTF-8 en_US.UTF-8 || true
    else
      echo "[fix-locale] WARNING: No localedef and no locale-gen. Cannot generate locales on this host."
      echo "[fix-locale] Available locales:"
      locale -a || true
      exit 1
    fi
    ;;
esac

echo "[fix-locale] Final locales:"
locale -a 2>/dev/null | grep -i 'en_US' || true
