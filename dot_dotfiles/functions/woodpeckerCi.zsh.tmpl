# woodpecker repo activator
# Requirements: curl, jq
#
# Env vars (optional; will be overridden by -u/-t if provided):
#   WOODPECKER_URL
#   WOODPECKER_TOKEN
#
# Usage:
#   wp-enable-repo exampleRepo
#   wp-enable-repo llajas/exampleRepo
#   wp-enable-repo -u https://ci.your.domain -t "$TOKEN" exampleRepo
#   wp-enable-repo -n "exampleRepo"          # explicit name match
#   wp-enable-repo -f "llajas/exampleRepo"   # explicit full_name match
#
# Notes:
# - Refuses if multiple repos match and you didn't provide full_name.
# - If already active, exits cleanly.
# - Designed to be safe in an interactive shell (won't close your terminal).

wp-enable-repo() {
  emulate -L zsh
  set -o pipefail

  # ---- defaults / creds ----
  local opi="{{ .opIds.woodpecker.uuid }}"
  local url="${WOODPECKER_URL:-}"
  local token="${WOODPECKER_TOKEN:-}"
  local mode="auto" # auto|name|full
  local query=""
  local all="true"

  # Prefer your 1Password helpers for defaults if env not set
  if [[ -z "$url" ]]; then
    if command -v opUrl >/dev/null 2>&1; then
      url="$(opUrl "$opi" 2>/dev/null || true)"
    fi
  fi
  if [[ -z "$token" ]]; then
    if command -v creds >/dev/null 2>&1; then
      token="$(creds "$opi" "{{ .opIds.woodpecker.key }}" 2>/dev/null || true)"
    fi
  fi
  if [[ -z "$url" ]]; then
    url="https://ci.your.domain"
  fi

  # ---- helper: detect repo from git remote ----
  _wp_detect_repo_query() {
    # prints either "owner/repo" or "repo" to stdout
    local remote urlp hostpath owner repo

    if ! command -v git >/dev/null 2>&1; then
      return 1
    fi
    if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
      return 1
    fi

    remote="$(git remote 2>/dev/null | head -n1)"
    [[ -z "$remote" ]] && return 1

    urlp="$(git remote get-url "$remote" 2>/dev/null || true)"
    [[ -z "$urlp" ]] && return 1

    # Normalize:
    # - https://host/owner/repo(.git)
    # - ssh://git@host/owner/repo(.git)
    # - git@host:owner/repo(.git)
    # - host:owner/repo(.git) (rare)
    #
    # Extract "owner/repo" when possible.
    if [[ "$urlp" == http*://* ]]; then
      hostpath="${urlp#*://}"     # host/owner/repo(.git)
      hostpath="${hostpath#*/}"   # owner/repo(.git)
    elif [[ "$urlp" == ssh://* ]]; then
      hostpath="${urlp#ssh://}"   # git@host/owner/repo(.git)
      hostpath="${hostpath#*/}"   # owner/repo(.git)
    elif [[ "$urlp" == *:*/* ]]; then
      hostpath="${urlp#*:}"       # owner/repo(.git)
    else
      # Unknown format; fallback to directory name later.
      hostpath=""
    fi

    if [[ -n "$hostpath" ]]; then
      hostpath="${hostpath%.git}"
      owner="${hostpath%%/*}"
      repo="${hostpath##*/}"
      if [[ -n "$owner" && -n "$repo" && "$owner" != "$repo" ]]; then
        print -r -- "${owner}/${repo}"
        return 0
      fi
    fi

    # fallback: directory name (repo)
    repo="$(basename -- "$(git rev-parse --show-toplevel 2>/dev/null || pwd)")"
    [[ -n "$repo" ]] || return 1
    print -r -- "$repo"
    return 0
  }

  # ---- args ----
  local OPTIND opt
  while getopts ":u:t:n:f:h" opt; do
    case "$opt" in
      u) url="$OPTARG" ;;
      t) token="$OPTARG" ;;
      n) mode="name"; query="$OPTARG" ;;
      f) mode="full"; query="$OPTARG" ;;
      h)
        cat <<'EOF'
wp-enable-repo: activate a Woodpecker repo by name/full_name via API

Usage:
  wp-enable-repo                 # auto-detect from current git repo
  wp-enable-repo <repoName>      # match by name
  wp-enable-repo <owner/repo>    # match by full_name
  wp-enable-repo -n <repoName>   # explicit name match
  wp-enable-repo -f <owner/repo> # explicit full_name match
  wp-enable-repo -u <url> -t <token> [repoName|owner/repo]
EOF
        return 0
        ;;
      \?)
        echo "Unknown option: -$OPTARG" >&2
        return 2
        ;;
      :)
        echo "Option -$OPTARG requires an argument" >&2
        return 2
        ;;
    esac
  done
  shift $((OPTIND-1))

  # If no query provided by flags or args, auto-detect from git
  if [[ -z "$query" ]]; then
    if [[ $# -ge 1 ]]; then
      query="$1"
    else
      if ! query="$(_wp_detect_repo_query 2>/dev/null)"; then
        echo "No repo argument provided, and I couldn't detect a git repo here." >&2
        echo "Run inside a git repo, or provide: wp-enable-repo <repoName|owner/repo>" >&2
        return 2
      fi
      # mode stays "auto" so owner/repo will be treated as full_name automatically
      echo "Detected repo: ${query}"
    fi
  fi

  # ---- deps ----
  if ! command -v jq >/dev/null 2>&1; then
    echo "jq is required. Install jq and retry." >&2
    return 2
  fi
  if ! command -v curl >/dev/null 2>&1; then
    echo "curl is required. Install curl and retry." >&2
    return 2
  fi
  if [[ -z "$token" ]]; then
    echo "Missing token. Set WOODPECKER_TOKEN, pass -t, or ensure creds() returns it." >&2
    return 2
  fi

  # ---- fetch repos ----
  local repos_json
  repos_json="$(
    curl -fsS -X GET \
      "${url%/}/api/user/repos?all=${all}" \
      -H "accept: application/json" \
      -H "Authorization: Bearer ${token}" \
    || true
  )"
  if [[ -z "$repos_json" ]]; then
    echo "Failed to fetch repos from Woodpecker: ${url%/}/api/user/repos?all=${all}" >&2
    return 1
  fi
  if ! echo "$repos_json" | jq -e . >/dev/null 2>&1; then
    echo "Woodpecker returned non-JSON (or jq couldn't parse it)." >&2
    echo "Raw response (first 400 chars):" >&2
    echo "${repos_json:0:400}" >&2
    return 1
  fi

  # ---- decide match mode ----
  local is_fullname="false"
  if [[ "$mode" == "full" ]]; then
    is_fullname="true"
  elif [[ "$mode" == "name" ]]; then
    is_fullname="false"
  else
    if [[ "$query" == */* ]]; then
      is_fullname="true"
    else
      is_fullname="false"
    fi
  fi

  # ---- find matches ----
  local matches_json
  if [[ "$is_fullname" == "true" ]]; then
    matches_json="$(echo "$repos_json" | jq -c --arg q "$query" '[ .[] | select(.full_name == $q) ]' 2>/dev/null || true)"
  else
    matches_json="$(echo "$repos_json" | jq -c --arg q "$query" '[ .[] | select(.name == $q) ]' 2>/dev/null || true)"
  fi
  [[ -n "$matches_json" ]] || { echo "Failed to filter repos (jq error)." >&2; return 1; }

  local match_count
  match_count="$(echo "$matches_json" | jq -r 'length' 2>/dev/null || echo 0)"

  # If autodetected just "repo" and there are multiple, try narrowing by origin owner if we can
  if [[ "$match_count" -gt 1 && "$is_fullname" != "true" && "$mode" == "auto" ]]; then
    # Try re-detecting full_name from origin and re-match if itâ€™s of the form owner/repo
    local detected_full
    detected_full="$(_wp_detect_repo_query 2>/dev/null || true)"
    if [[ "$detected_full" == */* ]]; then
      local narrowed
      narrowed="$(echo "$repos_json" | jq -c --arg q "$detected_full" '[ .[] | select(.full_name == $q) ]' 2>/dev/null || true)"
      if [[ -n "$narrowed" && "$(echo "$narrowed" | jq -r 'length' 2>/dev/null || echo 0)" -eq 1 ]]; then
        matches_json="$narrowed"
        match_count=1
        is_fullname="true"
        query="$detected_full"
      fi
    fi
  fi

  if [[ "$match_count" -eq 0 ]]; then
    echo "No matching repo found in Woodpecker for: ${query}" >&2
    return 1
  fi

  if [[ "$match_count" -gt 1 ]]; then
    echo "Multiple repos matched '${query}'. Please use full_name (owner/repo):" >&2
    echo "$matches_json" | jq -r '.[] | "  - \(.full_name) (active=\(.active))"' >&2
    return 1
  fi

  local forge_remote_id full_name active
  forge_remote_id="$(echo "$matches_json" | jq -r '.[0].forge_remote_id' 2>/dev/null || true)"
  full_name="$(echo "$matches_json" | jq -r '.[0].full_name' 2>/dev/null || true)"
  active="$(echo "$matches_json" | jq -r '.[0].active' 2>/dev/null || true)"

  if [[ -z "$forge_remote_id" || "$forge_remote_id" == "null" ]]; then
    echo "Matched ${full_name:-<unknown>} but forge_remote_id was missing." >&2
    return 1
  fi

  if [[ "$active" == "true" ]]; then
    echo "Already active: ${full_name} (forge_remote_id=${forge_remote_id})"
    return 0
  fi

  if ! curl -fsS -X POST \
      "${url%/}/api/repos?forge_remote_id=${forge_remote_id}" \
      -H "accept: application/json" \
      -H "Authorization: Bearer ${token}" >/dev/null; then
    echo "Activation failed for ${full_name} (forge_remote_id=${forge_remote_id})." >&2
    return 1
  fi

  echo "Activated: ${full_name} (forge_remote_id=${forge_remote_id})"
}

