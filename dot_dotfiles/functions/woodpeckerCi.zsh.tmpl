# woodpecker repo activator
# Requirements: curl, jq
#
# Env vars (optional; will be overridden by -u/-t if provided):
#   WOODPECKER_URL
#   WOODPECKER_TOKEN
#
# Usage:
#   wp-enable-repo exampleRepo
#   wp-enable-repo llajas/exampleRepo
#   wp-enable-repo -u https://ci.your.domain -t "$TOKEN" exampleRepo
#   wp-enable-repo -n "exampleRepo"          # explicit name match
#   wp-enable-repo -f "llajas/exampleRepo"   # explicit full_name match
#
# Notes:
# - Refuses if multiple repos match and you didn't provide full_name.
# - If already active, exits cleanly.
# - Designed to be safe in an interactive shell (won't close your terminal).

wp-enable-repo() {
  emulate -L zsh
  set -o pipefail

  # ---- defaults / creds ----
  local opi="{{ .opIds.woodpecker.uuid }}"
  local url="${WOODPECKER_URL:-}"
  local token="${WOODPECKER_TOKEN:-}"
  local mode="auto" # auto|name|full
  local query=""
  local all="true"

  # If you have your own helpers for 1Password lookups, prefer them as defaults.
  # Only attempt them if url/token weren't already set via env vars.
  if [[ -z "$url" ]]; then
    if command -v opUrl >/dev/null 2>&1; then
      url="$(opUrl "$opi" 2>/dev/null || true)"
    fi
  fi

  if [[ -z "$token" ]]; then
    if command -v creds >/dev/null 2>&1; then
      token="$(creds "$opi" "{{ .opIds.woodpecker.key }}" 2>/dev/null || true)"
    fi
  fi

  # Hard default if still empty
  if [[ -z "$url" ]]; then
    url="https://ci.your.domain"
  fi

  # ---- args ----
  local OPTIND opt
  while getopts ":u:t:n:f:h" opt; do
    case "$opt" in
      u) url="$OPTARG" ;;
      t) token="$OPTARG" ;;
      n) mode="name"; query="$OPTARG" ;;
      f) mode="full"; query="$OPTARG" ;;
      h)
        cat <<'EOF'
wp-enable-repo: activate a Woodpecker repo by name/full_name via API

Env:
  WOODPECKER_URL
  WOODPECKER_TOKEN

Usage:
  wp-enable-repo <repoName|owner/repo>
  wp-enable-repo -n <repoName>
  wp-enable-repo -f <owner/repo>
  wp-enable-repo -u <url> -t <token> <repoName|owner/repo>
EOF
        return 0
        ;;
      \?)
        echo "Unknown option: -$OPTARG" >&2
        return 2
        ;;
      :)
        echo "Option -$OPTARG requires an argument" >&2
        return 2
        ;;
    esac
  done
  shift $((OPTIND-1))

  if [[ -z "$query" ]]; then
    if [[ $# -lt 1 ]]; then
      echo "Missing repo name. Try: wp-enable-repo <repoName|owner/repo>" >&2
      return 2
    fi
    query="$1"
  fi

  # ---- deps ----
  if ! command -v jq >/dev/null 2>&1; then
    echo "jq is required. Install jq and retry." >&2
    return 2
  fi

  if ! command -v curl >/dev/null 2>&1; then
    echo "curl is required. Install curl and retry." >&2
    return 2
  fi

  if [[ -z "$token" ]]; then
    echo "Missing token. Set WOODPECKER_TOKEN, pass -t, or ensure creds() returns it." >&2
    return 2
  fi

  # ---- fetch repos ----
  local repos_json
  repos_json="$(
    curl -fsS -X GET \
      "${url%/}/api/user/repos?all=${all}" \
      -H "accept: application/json" \
      -H "Authorization: Bearer ${token}" \
    || true
  )"

  if [[ -z "$repos_json" ]]; then
    echo "Failed to fetch repos from Woodpecker: ${url%/}/api/user/repos?all=${all}" >&2
    echo "Check WOODPECKER_URL/token, or try: curl -v ..." >&2
    return 1
  fi

  # Ensure it's valid JSON (avoid jq killing the function unexpectedly)
  if ! echo "$repos_json" | jq -e . >/dev/null 2>&1; then
    echo "Woodpecker returned non-JSON (or jq couldn't parse it)." >&2
    echo "Raw response (first 400 chars):" >&2
    echo "${repos_json:0:400}" >&2
    return 1
  fi

  # ---- decide match mode ----
  local is_fullname="false"
  if [[ "$mode" == "full" ]]; then
    is_fullname="true"
  elif [[ "$mode" == "name" ]]; then
    is_fullname="false"
  else
    if [[ "$query" == */* ]]; then
      is_fullname="true"
    else
      is_fullname="false"
    fi
  fi

  # ---- find matches ----
  local matches_json
  if [[ "$is_fullname" == "true" ]]; then
    matches_json="$(echo "$repos_json" | jq -c --arg q "$query" '[ .[] | select(.full_name == $q) ]' 2>/dev/null || true)"
  else
    matches_json="$(echo "$repos_json" | jq -c --arg q "$query" '[ .[] | select(.name == $q) ]' 2>/dev/null || true)"
  fi

  if [[ -z "$matches_json" ]]; then
    echo "Failed to filter repos (jq error)." >&2
    return 1
  fi

  local match_count
  match_count="$(echo "$matches_json" | jq -r 'length' 2>/dev/null || echo 0)"

  if [[ "$match_count" -eq 0 ]]; then
    echo "No matching repo found in Woodpecker for: ${query}" >&2
    if [[ "$is_fullname" != "true" ]]; then
      echo "Tip: try owner/repo (full_name), e.g. llajas/${query}" >&2
    fi
    return 1
  fi

  if [[ "$match_count" -gt 1 ]]; then
    echo "Multiple repos matched '${query}'. Please use full_name (owner/repo):" >&2
    echo "$matches_json" | jq -r '.[] | "  - \(.full_name) (active=\(.active))"' >&2
    return 1
  fi

  local forge_remote_id full_name active
  forge_remote_id="$(echo "$matches_json" | jq -r '.[0].forge_remote_id' 2>/dev/null || true)"
  full_name="$(echo "$matches_json" | jq -r '.[0].full_name' 2>/dev/null || true)"
  active="$(echo "$matches_json" | jq -r '.[0].active' 2>/dev/null || true)"

  if [[ -z "$forge_remote_id" || "$forge_remote_id" == "null" ]]; then
    echo "Matched ${full_name:-<unknown>} but forge_remote_id was missing." >&2
    return 1
  fi

  if [[ "$active" == "true" ]]; then
    echo "Already active: ${full_name} (forge_remote_id=${forge_remote_id})"
    return 0
  fi

  # ---- activate ----
  if ! curl -fsS -X POST \
      "${url%/}/api/repos?forge_remote_id=${forge_remote_id}" \
      -H "accept: application/json" \
      -H "Authorization: Bearer ${token}" >/dev/null; then
    echo "Activation failed for ${full_name} (forge_remote_id=${forge_remote_id})." >&2
    return 1
  fi

  echo "Activated: ${full_name} (forge_remote_id=${forge_remote_id})"
}

