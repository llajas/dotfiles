#!/usr/bin/env bash
# chezmoi:chmod=755
set -euo pipefail

log() { printf '[copilot-installer] %s\n' "$*"; }

###############################################################################
# 1. Check prerequisites
###############################################################################

# Node.js
if ! command -v node >/dev/null 2>&1; then
  log "ERROR: Node.js is not installed. Install Node.js 22+ first."
  exit 1
fi

NODE_VERSION_RAW=$(node -v)          # e.g. v22.3.1
NODE_VERSION=${NODE_VERSION_RAW#v}   # strip leading v
NODE_MAJOR=${NODE_VERSION%%.*}       # take major

if [ "$NODE_MAJOR" -lt 22 ]; then
  log "ERROR: Node.js >= 22 is required (found $NODE_VERSION_RAW)."
  exit 1
fi

# npm
if ! command -v npm >/dev/null 2>&1; then
  log "ERROR: npm is not installed. Install npm 10+ first."
  exit 1
fi

NPM_VERSION_RAW=$(npm -v)            # e.g. 10.2.3
NPM_MAJOR=${NPM_VERSION_RAW%%.*}

if [ "$NPM_MAJOR" -lt 10 ]; then
  log "ERROR: npm >= 10 is required (found $NPM_VERSION_RAW)."
  exit 1
fi

log "Node.js $NODE_VERSION_RAW OK"
log "npm $NPM_VERSION_RAW OK"

###############################################################################
# 2. Check if Copilot CLI is already installed
###############################################################################

if npm list -g --depth=0 @github/copilot >/dev/null 2>&1; then
  log "Copilot CLI (@github/copilot) already installed. Nothing to do."
  exit 0
fi

log "Copilot CLI not found globally. Installingâ€¦"

###############################################################################
# 3. Install Copilot CLI globally
###############################################################################

npm install -g @github/copilot

# Verify install
if npm list -g --depth=0 @github/copilot >/dev/null 2>&1; then
  log "Copilot CLI installed successfully."
  exit 0
else
  log "ERROR: Copilot CLI installation appears to have failed."
  exit 1
fi