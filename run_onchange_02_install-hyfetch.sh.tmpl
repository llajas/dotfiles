#!/usr/bin/env bash
set -euo pipefail

{{/* ── Fetch latest HyFetch version from PyPI ───────────────────────────── */}}
{{- $meta   := (output "sh" "-c" "curl -s https://pypi.org/pypi/hyfetch/json") | fromJson -}}
{{- $latest := $meta.info.version -}}

# HyFetch PyPI version: {{ $latest }}
# ^ When this comment’s value changes, ChezMoi treats the file as modified,
#   so the run_onchange_ script re-runs and upgrades HyFetch.

{{/* ── Ensure pipx is present (Debian package “pipx”) ───────────────────── */}}
if ! command -v pipx >/dev/null 2>&1; then
  echo "[chezmoi] pipx not found; installing…"
  sudo apt update -qq
  sudo apt install -y pipx
  # Make sure ~/.local/bin is on PATH (harmless if it already is)
  pipx ensurepath
fi

{{/* ── Install or upgrade HyFetch via pipx (isolated venv, safe for PEP 668) */}}
if pipx list | grep -q '^package\s\+hyfetch'; then
  echo "[chezmoi] Upgrading HyFetch to {{ $latest }} with pipx…"
else
  echo "[chezmoi] Installing HyFetch {{ $latest }} with pipx…"
fi

pipx install --force hyfetch   # --force ensures upgrade if it already exists

echo "[chezmoi] HyFetch ready – version $(hyfetch --version 2>/dev/null || true)"
