#!/usr/bin/env bash
# chezmoi:template
# chezmoi:chmod=755
set -Eeuo pipefail

# SHA256 of packaged-software: {{ include ".chezmoitemplates/packaged-software" | sha256sum }}

log() { printf '[chezmoi] %s\n' "$*"; }

##############################################################################
# 0. Choose a safe runtime locale for Ansible
##############################################################################
# We don't trust whatever LANG/LC_ALL the shell has (they might point at a
# non-existent locale like en_US.UTF-8 before it's generated), so we force
# something that actually exists: C.UTF-8 if available, else C.
SAFE_LANG="C"

if command -v locale >/dev/null 2>&1; then
  # Probe with a known-good environment so locale -a itself doesn't error
  if LC_ALL=C LANG=C locale -a 2>/dev/null | grep -qi 'C\.utf8'; then
    SAFE_LANG="C.UTF-8"
  fi
fi

export LANG="$SAFE_LANG"
export LC_ALL="$SAFE_LANG"
unset LANGUAGE || true

log "Using runtime locale for Ansible: LANG=$LANG LC_ALL=$LC_ALL"

##############################################################################
# 1. Locate playbook directory
##############################################################################
# Render-time constant: where the *source* repo lives on this host.
SOURCE_ROOT="{{ .chezmoi.sourceDir }}"

if [[ -d "$HOME/.init-playbooks" ]]; then
  PLAYBOOK_DIR="$HOME/.init-playbooks"             # normal cloned workflow
else
  PLAYBOOK_DIR="$SOURCE_ROOT/.init-playbooks"      # container/bind-mount test
fi

PLAYBOOK_FILE="${PLAYBOOK_DIR}/bootstrap.yml"
ANSIBLE_CFG="${PLAYBOOK_DIR}/ansible.cfg"

##############################################################################
# 2. Sanity checks
##############################################################################
log "Checking prerequisites …"

if ! command -v ansible-playbook &>/dev/null; then
  log "Ansible is not installed. Aborting."
  exit 1
fi

if [[ ! -f "$PLAYBOOK_FILE" ]]; then
  log "Playbook file not found at $PLAYBOOK_FILE"
  exit 1
fi

##############################################################################
# 3. Pre-warm sudo (optional, non-interactive)
##############################################################################
log "Pre-warming sudo …"
sudo -n true || true

##############################################################################
# 4. Run the playbook
##############################################################################
log "Running Ansible playbook …"

export ANSIBLE_CONFIG="$ANSIBLE_CFG"

pushd "$PLAYBOOK_DIR" >/dev/null
ansible-playbook "$PLAYBOOK_FILE" \
  --diff \
  --become \
  --become-user=root \
  --become-method=sudo \
  -v
popd >/dev/null

log "Playbook completed successfully."
